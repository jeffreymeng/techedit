<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="utf-8">
	<meta content="width=device-width, initial-scale=1, shrink-to-fit=no" name="viewport">
	<meta content="" name="description">
	<meta content="Jeffrey Meng" name="author">
	<title>Techedit</title>

	<!-- Favicons -->

	<link rel="apple-touch-icon-precomposed" sizes="57x57" href="/favicon/apple-touch-icon-57x57.png" />
	<link rel="apple-touch-icon-precomposed" sizes="114x114" href="/favicon/apple-touch-icon-114x114.png" />
	<link rel="apple-touch-icon-precomposed" sizes="72x72" href="/favicon/apple-touch-icon-72x72.png" />
	<link rel="apple-touch-icon-precomposed" sizes="144x144" href="/favicon/apple-touch-icon-144x144.png" />
	<link rel="apple-touch-icon-precomposed" sizes="60x60" href="/favicon/apple-touch-icon-60x60.png" />
	<link rel="apple-touch-icon-precomposed" sizes="120x120" href="/favicon/apple-touch-icon-120x120.png" />
	<link rel="apple-touch-icon-precomposed" sizes="76x76" href="/favicon/apple-touch-icon-76x76.png" />
	<link rel="apple-touch-icon-precomposed" sizes="152x152" href="/favicon/apple-touch-icon-152x152.png" />
	<link rel="icon" type="image/png" href="/favicon/favicon-196x196.png" sizes="196x196" />
	<link rel="icon" type="image/png" href="/favicon/favicon-96x96.png" sizes="96x96" />
	<link rel="icon" type="image/png" href="/favicon/favicon-32x32.png" sizes="32x32" />
	<link rel="icon" type="image/png" href="/favicon/favicon-16x16.png" sizes="16x16" />
	<link rel="icon" type="image/png" href="/favicon/favicon-128.png" sizes="128x128" />
	<meta name="application-name" content="&nbsp;" />
	<meta name="msapplication-TileColor" content="#FFFFFF" />
	<meta name="msapplication-TileImage" content="/favicon/mstile-144x144.png" />
	<meta name="msapplication-square70x70logo" content="/favicon/mstile-70x70.png" />
	<meta name="msapplication-square150x150logo" content="/favicon/mstile-150x150.png" />
	<meta name="msapplication-wide310x150logo" content="/favicon/mstile-310x150.png" />
	<meta name="msapplication-square310x310logo" content="/favicon/mstile-310x310.png" />

	<!-- Bootstrap core CSS -->
	<link href="/css/bootstrap.min.css" rel="stylesheet">

	<!-- Custom fonts -->
	<link href="/css/simple-line-icons.css" rel="stylesheet" type="text/css">
	<link href="https://fonts.googleapis.com/css?family=Lato:300,400,700,300italic,400italic,700italic" rel="stylesheet" type="text/css"><!-- Custom styles for this template -->

	<link href="/css/bootstrap-select.css" rel="stylesheet">

	<!-- cookie consent -->
	<link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/cookieconsent2/3.1.0/cookieconsent.min.css" />
	<script src="https://cdnjs.cloudflare.com/ajax/libs/cookieconsent2/3.1.0/cookieconsent.min.js"></script>
	<script>
		window.addEventListener("load", function(){
			window.cookieconsent.initialise({
				"palette": {
					"popup": {
						"background": "#000"
					},
					"button": {
						"background": "#f1d600"
					}
				},
				"position": "bottom-right",
				"content": {
					"message": "Techedit uses cookies to ensure you get the best experience on our website.",
					"link": "Learn more about cookies"
				}
			})});
	</script>


	<link href="/css/techedit.css" rel="stylesheet">
	<link href="/css/editor.css" rel="stylesheet">
	<style>

	</style>
</head>
<body>

<nav class="navbar navbar-expand-lg navbar-dark bg-dark">
	<a class="navbar-brand" href="/">Techedit</a>
	<button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#nav-toggle" aria-controls="nav-toggle" aria-expanded="false" aria-label="Toggle navigation">
		<span class="navbar-toggler-icon"></span>
	</button>

	<div class="collapse navbar-collapse" id="nav-toggle">

		<span class="navbar-text mx-3">Go to:</span>

		<div class="form-inline mr-auto my-2 my-lg-0">
			<input class="form-control" type="text" placeholder="Existing File ID" id="nav-file-id" tabindex="2">
			<button class="btn btn-secondary" id="nav-file-id-btn">Go!</button>
		</div>
		<ul class="navbar-nav ml-auto mt-2 mt-lg-0">
			<li class="nav-item">
				<a class="nav-link" href="#">New File</a>
			</li>

			<li class="nav-item">
				<a class="nav-link" href="#">Sign in</a>
			</li>
		</ul>
	</div>
</nav>
<div id="loader" class="text-center">
	<div class="spinner">
		<div class="bounce1"></div>
		<div class="bounce2"></div>
		<div class="bounce3"></div>
	</div>
</div>
<div id="split-wrapper" class="hidden">
	<div id="editor-box" class="split">
		<div id="editor"></div>
	</div>
	<div id="sidebar" class="split">
		<div class="p-3">
			<div id="alertbox"></div>
			<h1>index.html</h1>
			<h3>Settings</h3>
			<div id="settings-form" class="form">
				<div class="form-group form-inline">
					<label for="lang-select">Language:</label>
					<select class="selectpicker form-control" id="lang-select">
						<option value="html">HTML</option>
						<option value="css">CSS</option>
						<option value="javascript">Javascript</option>
						<option value="java">Java</option>
						<option value="text">Plain Text</option>

					</select>
				</div>
				<div class="form-group form-inline">
					<label for="lang-select">Theme:</label>
					<select class="selectpicker form-control" id="theme-select">
						<optgroup label="Light">
							<option value="xcode">Xcode</option>
							<option value="dawn">Dawn</option>
							<option value="solarized_light">Solarized Light</option>
						</optgroup>
						<optgroup label="Dark">
							<option value="monokai" selected>Monokai</option>
							<option value="solarized_dark">Solarized Dark</option>
						</optgroup>
					</select>
				</div>
			</div>
			<div id="userlist-box">
				<h3>Active</h3>
				<div id="userlist-alertbox"></div>
				<div id="userlist-full">
					<ul id="userlist">

						<li class="userlist-li" id="userlist-current-user">
							<div class="userlist-wrapper">
								<div class="userlist-color-indicator" id="userlist-currentuser-color-indicator"></div>

								<div class="userlist-username">
									<div class="input-group mb-3" id="userlist-currentuser-inputgroup">

										<input type="text" class="form-control" placeholder="Username" id="userlist-currentuser-input">
										<div class="input-group-append" id="userlist-currentuser-input-confirmbox">
											<button class="btn btn-success" type="button" id="userlist-currentuser-input-confirm">&check;</button>
										</div>
									</div>
								</div>
							</div>
						</li>
					</ul>
				</div>
				<div id="userlist-light-box" class="hidden">
					<div id="userlist-light-current-user">
						<label>Your Username:</label>
						<input type="text" class="form-control" placeholder="Username" id="userlist-light-currentuser-input">
						<button class="btn btn-block btn-success mt-2 mb-4" id="userlist-light-currentuser-input-confirm">Update</button>
					</div>
					<ul id="userlist-light">

					</ul>
				</div>
			</div>
		</div>
	</div>


</div>

<!-- Bootstrap core JavaScript -->
<script src="/js/jquery.min.js"></script>
<script src="/js/bootstrap.bundle.min.js"></script>
<script src="/js/ace/ace.js" type="text/javascript" charset="utf-8"></script>
<script src="/js/split.min.js" type="text/javascript" charset="utf-8"></script>
<script src="/js/bootstrap-select.js" type="text/javascript" charset="utf-8"></script>
<script src="/js/cookie.min.js" type="text/javascript" charset="utf-8"></script>
<script src="/js/firepad.min.js" type="text/javascript" charset="utf-8"></script>
<script src="https://www.gstatic.com/firebasejs/5.5.5/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/5.5.5/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/5.5.5/firebase-database.js"></script>

<script>
	// Initialize Firebase
	var config = {
		apiKey: "AIzaSyABAa5dEDjLd46i01STVlapvKrFFMinTqo",
		authDomain: "techedit-io.firebaseapp.com",
		databaseURL: "https://techedit-io.firebaseio.com",
		projectId: "techedit-io",
		storageBucket: "techedit-io.appspot.com",
		messagingSenderId: "84859966897"
	};
	firebase.initializeApp(config);
</script>
<script src="/js/techedit.js" type="text/javascript" charset="utf-8"></script>
<script src="/js/edit-helpers.js" type="text/javascript" charset="utf-8"></script>

<script>

	function updateSidebarTheme(editor, light) {

		var themeColor = getComputedStyle(editor.renderer.scroller).backgroundColor;

		//convert to int array [r, g, b]
		themeColor = themeColor.replace(/[^\d,]/g, '').split(',');

		var textColor;
		var r = themeColor[0];
		var g = themeColor[1];
		var b = themeColor[2];

		if ((!light && light != null) || getBrightness(r, g, b) < 123) {

			textColor = "#ced4da";
			gutterColor = "#6c757d";
			$('.selectpicker').selectpicker("setStyle", "btn-light", "remove");
			$('.selectpicker').selectpicker("setStyle", "btn-secondary", "add");
		} else {
			textColor = "#000000";
			gutterColor = "#EEEEEE";
			$('.selectpicker').selectpicker("setStyle", "btn-secondary", "remove");
			$('.selectpicker').selectpicker("setStyle", "btn-light", "add");
		}
		var backgroundColor = "rgb(" + r + ", " + g + ", " + b + ")";

		$("#sidebar").css("background-color", backgroundColor);
		$("#sidebar").css("color", textColor);
		$(".gutter").css("background-color", gutterColor);


	}

	function stopLoading() {
		$("#loader").addClass("hidden");
		$("#split-wrapper").removeClass("hidden");
	}
	function onLanguageChange() {
		editor.getSession().setMode("ace/mode/" + $("#lang-select").val());
		firebase.database().ref("/f/test/data/language/").set($("#lang-select").val());
	}
	function addUserToUserlist(username, color) {
		var html = `<li class="userlist-li userlist-addedbyjs"><div class="userlist-wrapper">` +
			`<div class="userlist-color-indicator" style="background-color:${color};"></div> ` +
			`<div class="userlist-username">${username}</div></div></li>` //+
			/*`<br class="userlist-linebreak userlist-addedbyjs"><br class="userlist-linebreak userlist-addedbyjs">`*/;
		var lighthtml = `<li class="userlist-light-li userlist-addedbyjs">${username}</li>`;

		$("#userlist").append(html);
		$("#userlist-light").append(lighthtml);
		return html;
	}
	function resetUserlist() {
		$(".userlist-addedbyjs").remove();
	}
	function onUserlistResize() {
		var fullHiddenBefore = $("#userlist-full").hasClass("hidden");
		if ($("#userlist-box").width() < 325) {
			if (!fullHiddenBefore) {
				$("#userlist-light-currentuser-input").val($("#userlist-currentuser-input").val());
			}
			$("#userlist-full").addClass("hidden");
			$("#userlist-light-box").removeClass("hidden");
		} else {
			if (fullHiddenBefore) {
				$("#userlist-currentuser-input").val($("#userlist-light-currentuser-input").val());
			}
			$("#userlist-full").removeClass("hidden");
			$("#userlist-light-box").addClass("hidden");
		}
	}
	function setConfirmBoxVisible(visible) {
		if (visible) {
			var html =
				`<div class="input-group-append" id="userlist-currentuser-input-confirmbox">` +
					`<button class="btn btn-success" type="button" id="userlist-currentuser-input-confirm">submit</button>` +
				`</div>`;

			// if the confirm box doesn't already exist
			if ($("#userlist-currentuser-input-confirmbox").length == 0) {
				$("#userlist-currentuser-inputgroup").append(html);
			}

		} else {
			//detach removes the element but keeps click handlers
			$("#userlist-currentuser-input-confirmbox").detach();
		}
	}
	function setUserData(user, path, value) {//path should be relative to /users/$UID/
		if (user != null) {
			firebase.database().ref("/users/" + user.uid + "/data/" + (path.replaceAll(".", "/") || "")).set(value);

		} else {
			console.log(value);
			console.log(path);
			console.log(data);
			var data = Cookies.get("techedit-anonymous-user-data");
			if (data == undefined) {
				data = {}
			} else {
				data = JSON.parse(data);
			}

			if (path == null || path == "") {
				data = value;
			} else {
				setObjectValueByString(path, data, value);
			}
			console.log(data);
			Cookies.set("techedit-anonymous-user-data", data, {expires:1});

		}
	}
	function setDisplayName(userId, userDisplayName) {//path should be relative to /users/$UID/
		console.log(userId);
		console.log(userDisplayName);
		firebase.database().ref("/f/" +fileId + "/users/" + userId + "/displayName/").set(userDisplayName);
	}
	function stripUsername(username) {

		return username.substring(0, 32).replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;');

	}
	function reverseStripUsername(username) {

		return username.replace(/&amp;/g, '&').replace(/&lt;/g, '<').replace(/&gt;/g, '>').replace(/&quot;/g, '"');

	}
	function safeStripUsername(username) {
		//this can be used to strip a username that should already be stripped
		//if the username has all quotes then it each quote could potentially end up being 6 characters.
		return username.substring(0, 32 * 6).replace(/</g, '&lt;').replace(/"/g, '&quot;');
	}

	//specifying a type will ensure that only one alert of that type ever exists. Newer alerts
	//override old ones
	function addAlert(message, strong, level, location, type) {
		var fullTypeText = "";
		if (type) {
			$(".techedit-alert-type-" + type).remove();
			fullTypeText = "techedit-alert-type-" + type;
		}
		var alertbox = "alertbox";
		if (alertbox) {
			alertbox = location + "-" + alertbox;
		}
		var level = level || "danger";
		var html = `<div class="alert alert-${level} alert-dismissible fade show ${fullTypeText}" role="alert">` +
					  	`<strong>${strong}</strong> ${message}` +
					  	`<button type="button" class="close" data-dismiss="alert" aria-label="Close">` +
							`<span aria-hidden="true">&times;</span>` +
					  	`</button>`
					`</div>`;
		$("#" + alertbox).append(html);

	}
</script>
<script>
	var editor = ace.edit("editor");
	var fileId = "test";
	firebase.auth().onAuthStateChanged(function(user) {
		if (user) {
			firebase.database().get("/users/" + user.uid + "/data/").once("value").then(function(snapshot) {
				var userdata = snapshot.val();
				userdata.uid = user.uid;
				main(user, userdata);
			});
		} else {
			//user is null
			var cookie = Cookies.get("techedit-anonymous-user-data");
			if (cookie) {
				cookie = JSON.parse(cookie);
			}
			var anonData = cookie;
			var tempuid = firebase.database().ref("/f/" + fileId + "/users/").push().key;
			var defaultData = {
				uid:tempuid,
				displayName:tempuid
			};
			var anonData = merge(defaultData, anonData);
			setUserData(user, null, anonData);

			main(user, anonData);

		}
	});
	var theme;
	var userDisplayName;
	function main(user, userdata) {

		init(user, userdata);


		//define listeners

		editor.renderer.on("themeLoaded", function() {
			updateSidebarTheme(editor);
		});

		firebase.database().ref("/f/" + fileId + "/users/").on("value", function(snapshot) {
			resetUserlist();
			var users = snapshot.val();
			//https://stackoverflow.com/a/684692/5511561 (slightly adapted)
			for (var key in users) {
				if (users.hasOwnProperty(key)) {
					if (key != userdata.uid) {
						addUserToUserlist(safeStripUsername(users[key].displayName) || key, users[key].color);

					} else {
						$("#userlist-currentuser-input").val(reverseStripUsername(userDisplayName));
						$("#userlist-light-currentuser-input").val(reverseStripUsername(userDisplayName));
						$("#userlist-currentuser-color-indicator").css("background-color", userdata.color);
					}
				}
			}


		});
		firebase.database().ref("/f/" + fileId + "/data/language/").on("value", function(snapshot) {
			$("#lang-select").off("change", onLanguageChange);
			var lang = snapshot.val();
			$("#lang-select").selectpicker("val", lang);
			editor.getSession().setMode("ace/mode/" + lang);
			$("#lang-select").on("change", onLanguageChange);
		});



		$("#theme-select").change(function() {
			editor.setTheme("ace/theme/" + $("#theme-select").val());
			setUserData(user, "editor.theme", $("#theme-select").val());
			updateSidebarTheme(editor);

		});

		$("#userlist-currentuser-inputgroup").on("click", "#userlist-currentuser-input-confirm", function() {
			var username = $("#userlist-currentuser-input").val();
			setConfirmBoxVisible(false);
			userDisplayName = stripUsername(username);
			setUserData(user, "displayName", userDisplayName);
			setDisplayName(userdata.uid, userDisplayName);
			$("#userlist-light-currentuser-input").val(userDisplayName);
		});
		$("#userlist-light-currentuser-input-confirm").click(function() {
			var username = $("#userlist-light-currentuser-input").val();

			$("#userlist-light-currentuser-input-confirm").attr("disabled", "disabled");
			userDisplayName = stripUsername(username);
			setUserData(user, "displayName", userDisplayName);
			setDisplayName(userdata.uid, userDisplayName);
			$("#userlist-light-currentuser-input").val(userDisplayName);

		});
		$("#userlist-currentuser-input").keyup(function() {

			if (userDisplayName !== $(this).val()) {
				setConfirmBoxVisible(true);
			} else {
				setConfirmBoxVisible(false);
			}
		});

		$("#userlist-light-currentuser-input").keyup(function() {
			if (userDisplayName !== $(this).val()) {
				$("#userlist-light-currentuser-input-confirm").attr("disabled", false);
			} else {
				$("#userlist-light-currentuser-input-confirm").attr("disabled", "disabled");
			}

		});

	}
	function init(user, userdata) {

		if (userdata.editor) {
			//if userdata.editor.theme is undefined it will be caught at the if statement
			theme = userdata.editor.theme;
		}
		if (theme == undefined) {
			theme = "monokai";
			setConfirmBoxVisible(user, "editor.theme", theme);
		}

		userDisplayName = userdata.displayName;
		setConfirmBoxVisible(false);
		$("#userlist-light-currentuser-input-confirm").attr("disabled", "disabled");

		editor.setTheme("ace/theme/" + theme);
		$("#theme-select").selectpicker("val", theme);
		editor.getSession().setMode("ace/mode/text");
		editor.setShowPrintMargin(false);


		if( /Android|webOS|iPhone|iPad|iPod|BlackBerry/i.test(navigator.userAgent) ) {
			$(".selectpicker").selectpicker("mobile");
			$(".selectpicker").attr("data-mobile", "true");
		}


		var split = Split(["#editor-box", "#sidebar"],
			{
				onDragEnd:function() {
					editor.resize();

				},
				onDrag:onUserlistResize,
				minSize:0,
				sizes: [73, 27],
			});

		//check for sidebar resize
		$(window).resize(onUserlistResize);
		// Get Firebase Database reference.

		var firepadRef = firebase.database().ref("/f/" + fileId);

		firebase.database().ref("/f/" + fileId + "/data/").once("value").then(function(snapshot) {
			var data = snapshot.val();
			$("#lang-select").selectpicker("val", data.language);
			$("#lang-select").on("change", onLanguageChange);
			var firepad = Firepad.fromACE(firepadRef, editor, {
				userId:userdata.uid
			});

			firepad.on("ready", function() {
				stopLoading();
				onUserlistResize();

			});

		});
	}

</script>
</body>
</html>