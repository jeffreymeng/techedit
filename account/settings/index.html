<!DOCTYPE html>
<html lang="en">

<head>

	<meta charset="utf-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<meta name="viewport" content="width=device-width, initial-scale=1">


	<title>Techedit</title>

	<!-- Bootstrap Core CSS -->
	<link href="/css/bootstrap.min.css" rel="stylesheet">
	<!-- Social Button CSS -->
	<link rel="stylesheet" href="/css/bootstrap-social.css">
	<!-- Font Awesome CSS -->
	<link rel="stylesheet" href="/font-awesome/css/font-awesome.min.css">
	<!-- Custom CSS -->
	<style>
		body {
			padding-top: 70px;
			/* Required padding for .navbar-fixed-top. Remove if using .navbar-static-top. Change if height of navigation changes. */
		}
		
		#files {
			list-style-type: none;
		}
	</style>

	<!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
	<!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
	<!--[if lt IE 9]>
		<script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
		<script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
	<![endif]-->
	<!-- Begin Cookie Consent plugin by Silktide - http://silktide.com/cookieconsent -->
	<script type="text/javascript">
		window.cookieconsent_options = {
			"message": "Techedit uses cookies(pieces of text stored on your browser's cache) to ensure you get the best experience on our website.",
			"dismiss": "Got it!",
			"learnMore": "More info",
			"link": "",
			"theme": "light-bottom"
		};
	</script>

	<script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/cookieconsent2/1.0.10/cookieconsent.min.js"></script>
	<!-- End Cookie Consent plugin -->

</head>

<body>

	<!-- Navigation -->
	<nav class="navbar navbar-inverse navbar-fixed-top" role="navigation">
		<div class="container">
			<!-- Brand and toggle get grouped for better mobile display -->
			<div class="navbar-header">
				<button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#navbar-collapse">
					<span class="sr-only">Toggle navigation</span>
					<span class="icon-bar"></span>
					<span class="icon-bar"></span>
					<span class="icon-bar"></span>
				</button>
				<a class="navbar-brand" href="/">Techedit</a>
			</div>
			<!-- Collect the nav links, forms, and other content for toggling -->
			<div class="collapse navbar-collapse" id="navbar-collapse">
				<ul class="nav navbar-nav">
					<li>
						<a href="/new/">New File</a>
					</li>
					<li>
						<a href="/edit/">Edit File</a>
					</li>
					<li id="nav-collection" class="hidden">
						<a id="nav-collection-link" href="/collection/">My Collection</a>
					</li>
					<li id="nav-login" class="hidden">
						<a id="nav-login-link">Login</a>
					</li>
					<li class="dropdown hidden" id="nav-account">
						<a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false">Your Account <span class="caret"></span></a>
						<ul class="dropdown-menu">
							<li><a id="nav-logout-link">Logout</a></li>

							<li role="separator" class="divider"></li>
							<li><a href="/account/settings/">Account Settings</a></li>
						</ul>
					</li>
					<li class="dropdown" id="nav-account">
						<a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false">About <span class="caret"></span></a>
						<ul class="dropdown-menu">
							<li><a href="/support/">Support Portal</a></li>
							<li><a href="/support/contact/">Contact</a></li>
						</ul>
					</li>
				</ul>
			</div>
			<!-- /.navbar-collapse -->
		</div>
		<!-- /.container -->
	</nav>

	<!-- Page Content -->
	<div class="container">



		<div class="col-lg-12 text-center">
			<h1>Account Settings</h1>
			<hr>
			<div>

				<!-- Nav tabs -->
				<ul class="nav nav-tabs" role="tablist">
					<li role="presentation" class="active"><a href="#login-methods-div" aria-controls="login-methods-div" role="tab" data-toggle="tab">Login Methods</a></li>
					<li role="presentation" class="hidden" id="update-email-tab"><a href="#update-email" aria-controls="update-email" role="tab" data-toggle="tab">Update email</a></li>
					<li role="presentation" class="hidden" id="update-password-tab"><a href="#update-password" aria-controls="update-password" role="tab" data-toggle="tab">Update password</a></li>
					<li role="presentation" id="collection-tab"><a href="#collection" aria-controls="collection" role="tab" data-toggle="tab">Collection Settings</a></li>
				</ul>

				<!-- Tab panes -->
				<div class="tab-content">
					<div role="tabpanel" class="tab-pane fade in active" id="login-methods-div">
						<div class="alert alert-success hidden" role="alert" id="link-update-success">Successfully updated your login methods. If you added an email/password login method, then you will need to verify your email before you can login with it.</div>
						<div class="alert alert-danger hidden" role="alert" id="link-update-error">There was an error while updating your login methods.</div>
						<div class="alert alert-danger hidden" role="alert" id="link-account-in-use">The login method is already in use with another account.
							<!-- <a href="/support/account/login-methods/#error-login-method-already-in-use">Learn More</a>. --></div>
						<div class="alert alert-danger hidden" role="alert" id="link-account-in-use">The passwords don't match!</div>
						<h3>Login Methods</h3>
						<div id="login-methods"></div>
						<div id="link-buttons">
							<div id="password-link" class="hidden">
								<label for="password-link-email">Email for adding email/password login:</label>
								<input class="form-control" type="text" id="password-link-email">
								<label for="password-link-password">Password for adding email/password login:</label>
								<input class="form-control" type="password" id="password-link-password">
								<label for="password-link-password">Confirm password for adding email/password login:</label>
								<input class="form-control" type="password" id="password-link-confirm-password">
								<br>
								<button class="btn btn-primary link-login form-control" id="password-link-btn">Add email/password login</button>
							</div>
							<br>
							<a class="hidden btn btn-block btn-social btn-google link-login" id="google-link">
								<span class="fa fa-google"></span> Add Google login
							</a>
							<br>
							<a class="hidden btn btn-block btn-social btn-github link-login" id="github-link">
								<span class="fa fa-github"></span> Add Github login
							</a>
						</div>
					</div>
					<div role="tabpanel" class="tab-pane fade" id="update-email">
						<div class="alert alert-success hidden" role="alert" id="update-email-success">Successfully updated your email.</div>
						<div class="alert alert-danger hidden" role="alert" id="update-email-reauth-error">Error. The email/current - password comboniation could not be found.</div>
						<div class="alert alert-danger hidden" role="alert" id="update-email-error">Error updating your email. The email may already be in use, or may be badly formatted. </div>

						<h3>Update Your account email address</h3>
						<b>All email address update fields are required.</b>
						<br>
						<label for="update-email-email">Current Email:</label>
						<input class="form-control" type="text" id="update-email-email">
						<label for="update-email-password">Password:</label>

						<input class="form-control" type="password" id="update-email-password">
						<label for="update-email-new-email">New Email:</label>

						<input class="form-control" type="text" id="update-email-new-email">
						<button id="update-email-btn" class="form-control btn btn-primary">Update Email</button>
					</div>
					<div role="tabpanel" class="tab-pane fade" id="update-password">
						<div class="alert alert-success hidden" role="alert" id="update-password-success">Successfully updated your password.</div>
						<div class="alert alert-danger hidden" role="alert" id="update-password-reauth-error">Error. The email/current - password comboniation could not be found.</div>
						<div class="alert alert-danger hidden" role="alert" id="update-password-error">Error updating your password. The password may not be strong enough, or some other error occured.</div>
						<div class="alert alert-danger hidden" role="alert" id="update-password-nomatch">Error updating your password. The passwords do not match.</div>
						<h3>Update Your account password</h3>
						<b>All password update fields are required.</b>
						<br>
						<label for="update-password-email">Email:</label>
						<input class="form-control" type="text" id="update-password-email">
						<label for="update-password-password">Current Password:</label>
						<input class="form-control" type="password" id="update-password-password">
						<label for="update-password-new-password">New Password:</label>
						<input class="form-control" type="password" id="update-password-new-password">
						<label for="update-password-confirm-password">Confirm New Password:</label>
						<input class="form-control" type="password" id="update-password-confirm-password">
						<button id="update-password-btn" class="form-control btn btn-primary">Update Password</button>
					</div>
					<div role="tabpanel" class="tab-pane fade" id="collection">
						<h1>Collection Settings</h1>
						<a id="export-collection">Export Collection</a>
						<br>
						
						<hr>
						<button class="form-control btn btn-danger">Clear your collection</button>
					</div>
				</div>

			</div>

		</div>

		<!-- 
			TODO:
			Link Accounts    DONE
			Unlink Accounts  DONE
			Change Email     DONE
			Change Password  DONE
			Delete Account
			Clear Collection
			-->
	</div>



	<!-- /.row -->

	</div>
	<!-- /.container -->

	<!-- jQuery Version 1.11.1 -->
	<script src="/js/jquery.js"></script>

	<!-- Bootstrap Core JavaScript -->
	<script src="/js/bootstrap.min.js"></script>
	<script src="/js/list.js"></script>
	<script src="/js/list.pagnation.js"></script>
	<script src="/js/list.fuzzysearch.js"></script>

	<script src="https://www.gstatic.com/firebasejs/3.6.4/firebase.js"></script>
	<script>
		// Initialize Firebase
		var config = {
			apiKey: "AIzaSyBQ2E4ISQoIcRsDxfPxzDjbJwmD-r98JYw",
			authDomain: "techedit-63e7f.firebaseapp.com",
			databaseURL: "https://techedit-63e7f.firebaseio.com",
			storageBucket: "techedit-63e7f.appspot.com",
			messagingSenderId: "609280907475"
		};
		firebase.initializeApp(config);
	</script>
	<script src="/js/techedit.js"></script>
	<script>
		/* global $ firebase */

		firebase.auth().onAuthStateChanged(function(user) {
			if (user) {

				displayLinkedAccounts(user);
				updateEmail(user);
				updatePassword(user);

				collectionSettings(user);
			}
			else {
				window.location.href = "/account/login/?redir=" + encodeURIComponent(window.location.href);
			}
		});

		function removeElementFromArrayByValue(array, val) {
			var index = array.indexOf(val);

			if (index > -1) {
				array.splice(index, 1);
			}
			return array;
		}

		function collectionSettings(user) {

			firebase.database().ref("/u/" + user.uid + "/collections/").on("value", function(snapshot) {
				var dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(snapshot.val(), null, 2));
				$("#collection-export").attr("href", dataStr);
				$("#collection-export").attr("download", "techedit-collection-export.json");
			});
			$("#collection-delete").click(function() {
				confirmAction("Are you sure you want to clear your entire collection?", 
				"This will delete all your collected files. This action is not reversible, and once deleted, your data cannot be recovered. Once you clear your collection,"
				+ "Your collection will be empty. You can still add files to your collection. You can export your collection before deleting.(Click on cancel, then the export collection link.)",
				function(){
					firebase.database().ref("/u/" + user.uid + "/collections/").set(null);
				});
			});


		}

		function updateEmail(user) {

			for (var i = 0; i < user.providerData.length; i++) {
				if (user.providerData[i].providerId === "password") {
					$("#update-email-tab").removeClass("hidden");
					$("#update-email-btn").click(function() {

						confirmAction("Are you sure you want to change your Login email?",
							"You will not be able to login with the old email anymore. You will only be able to login with the new email and you will need to verify the new email before you can login with it." +
							"You will also recive an email in your old email account with a link to revert this action. This will only affect email/password login",

							function() {
								$("#confirm-modal").modal("hide");
								if ($("#update-email-email").val().replace(" ") !== "" && $("#update-email-email").val().replace(" ") !== null && $("#update-email-password").val().replace(" ") !== "" && $("#update-email-password").val().replace(" ") !== null && $("#update-email-new-email").val().replace(" ") !== "" && $("#update-email-new-email").val().replace(" ") !== null) {
									reauthenticate(user, $("#update-email-email").val(), $("#update-email-password").val(), "update-email-reauth-error", function() {
										var user = firebase.auth().currentUser;

										user.updateEmail($("#update-email-new-email").val()).then(function() {
											user.sendEmailVerification().then(function() {

												window.location.href = "/account/logout?continue=" + encodeURIComponent("https://techedit.jeffkmeng.com/account/login#emailchangesuccess");

											});
										});
									});
								}

								else {
									$(".alert").addClass("hidden");
									$("#update-email-error").removeClass("hidden");

								}
							});

					});
				}

			}

		}

		function updatePassword(user) {

			for (var i = 0; i < user.providerData.length; i++) {
				if (user.providerData[i].providerId === "password") {
					$("#update-password-tab").removeClass("hidden");
					$("#update-password-btn").click(function() {

						confirmAction("Are you sure you want to change your password?",
							"You will not be able to login with the old password anymore. You can reset your password at any time by clicking on the reset your password link on the login page. This will only affect email/password login.",

							function() {
								$("#confirm-modal").modal("hide");
								if ($("#update-password-email").val().replace(" ") !== "" && $("#update-password-email").val().replace(" ") !== null && $("#update-password-password").val().replace(" ") !== "" && $("#update-password-password").val().replace(" ") !== null && $("#update-password-new-password").val().replace(" ") !== "" && $("#update-password-new-password").val().replace(" ") !== null) {
									if ($("#update-password-new-password").val() === $("#update-password-confirm-password").val()) {
										reauthenticate(user, $("#update-password-email").val(), $("#update-password-password").val(), "update-password-reauth-error", function() {
											var user = firebase.auth().currentUser;
											user.updatePassword($("#update-password-new-password")).then(function() {
												window.location.href = "/account/logout?continue=" + encodeURIComponent("https://techedit.jeffkmeng.com/account/login#passwordchanged");

											}, function(error) {
												$(".alert").addClass("hidden");
												$("#update-password-error").removeClass("hidden");
											});

										});
									}
									else {
										$(".alert").addClass("hidden");
										$("#update-password-nomatch").removeClass("hidden");
									}
								}

								else {
									$(".alert").addClass("hidden");
									$("#update-password-error").removeClass("hidden");

								}
							});

					});
				}

			}

		}

		function reauthenticate(user, email, password, errorid, callback) {
			var credential = firebase.auth.EmailAuthProvider.credential(
				email,
				password
			);
			user.reauthenticate(credential).then(function() {
				callback();
				//console.log("reauthentication success!");
			}, function(error) {
				$(".alert").addClass("hidden");

				$("#" + errorid).removeClass("hidden");
				console.log(error);
			});
		}

		function displayLinkedAccounts(user) {
			var data;
			var providersLeft = ["password", "google.com", "github.com"];
			$("#login-methods").html("");
			$("#password-link").addClass("hidden");
			$("#github-link").addClass("hidden");
			$("#google-link").addClass("hidden");
			if (user.providerData.length > 1) {
				for (var i = 0; i < user.providerData.length; i++) {
					data = user.providerData[i];
					removeElementFromArrayByValue(providersLeft, data.providerId);
					$("#login-methods").append("<p><b>" + data.providerId + "</b> | <a class='unlink-btn' id='unlink-" + data.providerId + "'>Remove this method</a></p>");


				}
			}
			else {
				data = user.providerData[0];
				removeElementFromArrayByValue(providersLeft, data.providerId);
				$("#login-methods").append("<p><b>" + data.providerId === "password" ? "email/password" : data.providerId.replace(".com", "") + "</b></p>");

			}
			for (i = 0; i < providersLeft.length; i++) {
				if (providersLeft[i] === "google.com") {
					$("#google-link").removeClass("hidden");
				}
				else if (providersLeft[i] === "github.com") {
					$("#github-link").removeClass("hidden");
				}
				else {
					$("#password-link").removeClass("hidden");
				}
			}
			$(".unlink-btn").click(function() {
				var unlinkProvider;
				var unlinkProviderFull;
				var id = $(this).attr("id");
				if (id === "unlink-google.com") {
					unlinkProvider = "google";
					unlinkProviderFull = "google.com";
				}
				else if (id === "unlink-github.com") {
					unlinkProvider = "github";
					unlinkProviderFull = "github.com";
				}
				else {
					unlinkProvider = "password";
					unlinkProviderFull = "password";
				}
				confirmAction("Are you sure you want to remove the " + unlinkProvider + " login method form your account?",
					"This means that in the future, if you try to login with this provider, the account and data will not be shared with this account.",
					function() {
						$("#confirm-modal").modal("hide");
						user.unlink(unlinkProviderFull).then(function() {
							displayLinkedAccounts(user);
							$(".alert").addClass("hidden");
							$("#login-update-success").removeClass("hidden");

						}, function(error) {
							console.log(error);
							displayLinkedAccounts(user);
							$(".alert").addClass("hidden");
							$("#login-update-error").removeClass("hidden");

						});
					});

			});
			$(".link-login").click(function() {
				var linkProvider;
				//var linkProviderName;
				//var linkProviderFull;
				var id = $(this).attr("id");
				if (id === "google-link") {
					linkProvider = new firebase.auth.GoogleAuthProvider();

					//linkProviderName = "google";
					//linkProviderFull = "google.com";
					firebase.auth().currentUser.linkWithPopup(linkProvider).then(function(result) {
						$(".alert").addClass("hidden");
						$("#link-update-success").removeClass("hidden");
						displayLinkedAccounts(user);
					}).catch(function(error) {
						//console.log(error);
						if (error.code === "auth/email-already-in-use" || error.code === "auth/credential-already-in-use") {
							$(".alert").addClass("hidden");
							$("#link-account-in-use").removeClass("hidden");
							displayLinkedAccounts(user);
						}
						else {
							$(".alert").addClass("hidden");
							$("#link-update-error").removeClass("hidden");
							displayLinkedAccounts(user);
						}
					});
				}
				else if (id === "github-link") {
					linkProvider = new firebase.auth.GithubAuthProvider();
					//linkProviderName = "github";
					//linkProviderFull = "github.com";
					firebase.auth().currentUser.linkWithPopup(linkProvider).then(function(result) {
						$(".alert").addClass("hidden");
						$("#link-update-success").removeClass("hidden");
						displayLinkedAccounts(user);
					}).catch(function(error) {
						//console.log(error);
						if (error.code === "auth/email-already-in-use" || error.code === "auth/credential-already-in-use") {
							$(".alert").addClass("hidden");
							$("#link-account-in-use").removeClass("hidden");
							displayLinkedAccounts(user);
						}
						else {
							$(".alert").addClass("hidden");
							$("#link-update-error").removeClass("hidden");
							displayLinkedAccounts(user);
						}
					});
				}
				else {
					if ($("#password-link-password").val() !== $("#password-link-confirm-password").val()) {
						$(".alert").addClass("hidden");
						$("#link-password-nomatch").removeClass("hidden");
						displayLinkedAccounts(user);
					}
					else {
						linkProvider = firebase.auth.EmailAuthProvider.credential($("#password-link-email").val(), $("#password-link-password").val());
						//linkProviderName = "password";
						//linkProviderFull = "password";
						firebase.auth().currentUser.link(linkProvider).then(function(user) {
							user.sendEmailVerification().then(function() {
								$(".alert").addClass("hidden");
								$("#link-update-success").removeClass("hidden");
								displayLinkedAccounts(user);
							}).catch(function(error) {
								console.log(error);
								$(".alert").addClass("hidden");
								$("#link-update-error").removeClass("hidden");
								displayLinkedAccounts(user);
							});
						}, function(error) {
							console.log(error);
							if (error.code === "auth/email-already-in-use" || error.code === "auth/credential-already-in-use") {
								$(".alert").addClass("hidden");
								$("#link-account-in-use").removeClass("hidden");
								displayLinkedAccounts(user);
							}
							else {
								$(".alert").addClass("hidden");
								$("#link-update-error").removeClass("hidden");
								displayLinkedAccounts(user);
							}
						});
					}
				}

			});
		}

		function confirmAction(title, text, callback) {
			$("#confirm-modal-label").html(title);
			$("#confirm-modal-text").html(text);
			$("#confirm-modal-btn").on("click", callback);
			$(".confirm-modal-close").on("click", function() {
				$("#confirm-modal-btn").off("click", callback);
			});
			$("#confirm-modal").modal("show");


		}
	</script>
	<!-- Modal -->
	<div class="modal fade" id="confirm-modal" tabindex="-1" role="dialog" aria-labelledby="confirm-modal-label">
		<div class="modal-dialog" role="document">
			<div class="modal-content">
				<div class="modal-header">
					<button type="button" class="close confirm-modal-close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
					<h4 class="modal-title" id="confirm-modal-label">Modal title</h4>
				</div>
				<div class="modal-body">
					<p id="confirm-modal-text"></p>
				</div>
				<div class="modal-footer">
					<button type="button" class="btn btn-default confirm-modal-close" data-dismiss="modal">Cancel</button>
					<button type="button" class="btn btn-primary" id="confirm-modal-btn">Yes, I am sure</button>
				</div>
			</div>
		</div>
	</div>
</body>

</html>
