<!DOCTYPE html>
<html lang="en">

<head>

	<meta charset="utf-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<meta name="viewport" content="width=device-width, initial-scale=1">


	<title>Techedit</title>

	<!-- Bootstrap Core CSS -->
	<link href="/css/bootstrap.min.css" rel="stylesheet">
	<!-- Social Button CSS -->
	<link rel="stylesheet" href="/css/bootstrap-social.css">
	<!-- Font Awesome CSS -->
	<link rel="stylesheet" href="/font-awesome/css/font-awesome.min.css">
	<!-- Custom CSS -->
	<style>
		body {
			padding-top: 70px;
			/* Required padding for .navbar-fixed-top. Remove if using .navbar-static-top. Change if height of navigation changes. */
		}
		
		#files {
			list-style-type: none;
		}
	</style>

	<!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
	<!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
	<!--[if lt IE 9]>
		<script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
		<script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
	<![endif]-->

</head>

<body>

	<!-- Navigation -->
	<nav class="navbar navbar-inverse navbar-fixed-top" role="navigation">
		<div class="container">
			<!-- Brand and toggle get grouped for better mobile display -->
			<div class="navbar-header">
				<button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#navbar-collapse">
					<span class="sr-only">Toggle navigation</span>
					<span class="icon-bar"></span>
					<span class="icon-bar"></span>
					<span class="icon-bar"></span>
				</button>
				<a class="navbar-brand" href="/">Techedit</a>
			</div>
			<!-- Collect the nav links, forms, and other content for toggling -->
			<div class="collapse navbar-collapse" id="navbar-collapse">
				<ul class="nav navbar-nav">
					<li>
						<a href="/new/">New File</a>
					</li>
					<li>
						<a href="/edit/">Edit File</a>
					</li>
					<li id="nav-collection" class="hidden">
						<a id="nav-collection-link" href="/collection/">My Collection</a>
					</li>
					<li id="nav-login" class="hidden">
						<a id="nav-login-link">Login</a>
					</li>
					<p id="nav-logout" class="navbar-text navbar-right hidden">You are logged in. <a id="nav-logout-link" class="navbar-link">Logout</a></p>

				</ul>
			</div>
			<!-- /.navbar-collapse -->
		</div>
		<!-- /.container -->
	</nav>

	<!-- Page Content -->
	<div class="container">



		<div class="col-lg-12 text-center">
			<h1>Account Settings</h1>
			<hr>
			<h3>Login Methods</h3>
			<div class="alert alert-success hidden" role="alert" id="login-update-success">Successfully updated your login methods.</div>
			<div class="alert alert-danger hidden" role="alert" id="login-update-error">There was an error while updating your login methods.</div>

			<div id="login-methods">

			</div>
			<div id="link-buttons">
				<div id="password-link" class="hidden">
					<label for="password-link-email">Email for adding email/password login:</label>
					<input class="form-control" type="text" id="password-link-email">
					<label for="password-link-password">Password for adding email/password login:</label>
					<input class="form-control" type="password" id="password-link-password">
					<br>
					<button class="btn btn-primary link-login form-control" id="password-link-btn">Add email/password login</button>
				</div>
				<br>
				<a class="hidden btn btn-block btn-social btn-google link-login" id="google-link">
					<span class="fa fa-google"></span> Add Google login
				</a>
				<br>
				<a class="hidden btn btn-block btn-social btn-github link-login" id="github-link">
					<span class="fa fa-github"></span> Add Github login
				</a>
			</div>
			<!-- 
			TODO:
			Link Accounts
			Unlink Accounts
			Change Email
			Change Password
			Delete Account
			Clear Collection
			-->
		</div>



		<!-- /.row -->

	</div>
	<!-- /.container -->

	<!-- jQuery Version 1.11.1 -->
	<script src="/js/jquery.js"></script>

	<!-- Bootstrap Core JavaScript -->
	<script src="/js/bootstrap.min.js"></script>
	<script src="/js/list.js"></script>
	<script src="/js/list.pagnation.js"></script>
	<script src="/js/list.fuzzysearch.js"></script>

	<script src="https://www.gstatic.com/firebasejs/3.6.4/firebase.js"></script>
	<script>
		// Initialize Firebase
		var config = {
			apiKey: "AIzaSyBQ2E4ISQoIcRsDxfPxzDjbJwmD-r98JYw",
			authDomain: "techedit-63e7f.firebaseapp.com",
			databaseURL: "https://techedit-63e7f.firebaseio.com",
			storageBucket: "techedit-63e7f.appspot.com",
			messagingSenderId: "609280907475"
		};
		firebase.initializeApp(config);
	</script>
	<script src="/js/techedit.js"></script>
	<script>
		/* global $ firebase */

		firebase.auth().onAuthStateChanged(function(user) {
			if (user) {
				displayLinkedAccounts(user);
			}
			else {
				window.location.href = "/account/login/?redir=" + encodeURIComponent(window.location.href);
			}
		});

		function removeElementFromArrayByValue(array, val) {
			var index = array.indexOf(val);

			if (index > -1) {
				array.splice(index, 1);
			}
			return array;
		}

		function displayLinkedAccounts(user) {
			var data;
			var providersLeft = ["password", "google.com", "github.com"];
			$("#login-methods").html("");
			for (i = 0; i < providersLeft.length; i++) {
				$("#" + providersLeft[i] + "-login").addClass("hidden");
			}
			if (user.providerData.length > 1) {
				for (var i = 0; i < user.providerData.length; i++) {
					data = user.providerData[i];
					removeElementFromArrayByValue(providersLeft, data.providerId);
					$("#login-methods").append("<p><b>" + data.providerId + "</b> | <a class='unlink-btn' id='unlink-" + data.providerId + "' Remove this method</a></p>");


				}
			}
			else {
				data = user.providerData[0];
				removeElementFromArrayByValue(providersLeft, data.providerId);
				$("#login-methods").append("<p><b>" + data.providerId === "password" ? "email/password" : data.providerId.replace(".com", "") + "</b></p>");

			}
			for (i = 0; i < providersLeft.length; i++) {
				if (providersLeft[i] === "google.com") {
					$("#google-link").removeClass("hidden");
				} else if (providersLeft[i] === "github.com") {
					$("#github-link").removeClass("hidden");
				} else {
					$("#password-link").removeClass("hidden");
				}
			}
			$(".unlink-btn").click(function() {
				var unlinkProvider;
				var unlinkProviderFull;
				var id = $(this).attr("id");
				if (id === "unlink-google.com") {
					unlinkProvider = "google";
					unlinkProviderFull = "google.com";
				}
				else if (id === "unlink-github.com") {
					unlinkProvider = "github";
					unlinkProviderFull = "github.com";
				}
				else {
					unlinkProvider = "password";
					unlinkProviderFull = "password";
				}
				confirmAction("Are you sure you want to remove the " + unlinkProvider + " login method form your account?", "This means that in the future, if you try to login with this provider, the account and data will not be shared with this account.", function() {
					user.unlink(unlinkProviderFull).then(function() {
						displayLinkedAccounts(user);
						$(".alert").addClass("hidden");
						$("#login-update-success").removeClass("hidden");
					}, function(error) {
						displayLinkedAccounts(user);
						$(".alert").addClass("hidden");
						$("#login-update-error").removeClass("hidden");
					});
				});

			});
			$(".link-login").click(function() {
				var linkProvider;
				//var linkProviderName;
				//var linkProviderFull;
				var id = $(this).attr("id");
				if (id === "google-link") {
					linkProvider = new firebase.auth.GoogleAuthProvider();

					//linkProviderName = "google";
					//linkProviderFull = "google.com";
					firebase.auth().currentUser.linkWithPopup(linkProvider).then(function(result) {
						$(".alert").addClass("hidden");
						$("#login-update-success").removeClass("hidden");
						displayLinkedAccounts(user);
					}).catch(function(error) {
						$(".alert").addClass("hidden");
						$("#login-update-error").removeClass("hidden");
						displayLinkedAccounts(user);
					});
				}
				else if (id === "github-link") {
					linkProvider = new firebase.auth.GithubAuthProvider();
					//linkProviderName = "github";
					//linkProviderFull = "github.com";
					firebase.auth().currentUser.linkWithPopup(linkProvider).then(function(result) {
						$(".alert").addClass("hidden");
						$("#login-update-success").removeClass("hidden");
						displayLinkedAccounts(user);
					}).catch(function(error) {
						$(".alert").addClass("hidden");
						$("#login-update-error").removeClass("hidden");
						displayLinkedAccounts(user);
					});
				}
				else {
					linkProvider = firebase.auth.EmailAuthProvider.credential($("#password-link-email").val(), $("#password-link-password").val());
					//linkProviderName = "password";
					//linkProviderFull = "password";
					firebase.auth().currentUser.link(linkProvider).then(function(user) {
						$(".alert").addClass("hidden");
						$("#login-update-success").removeClass("hidden");
						displayLinkedAccounts(user);
					}, function(error) {
						$(".alert").addClass("hidden");
						$("#login-update-error").removeClass("hidden");
						displayLinkedAccounts(user);
					});
				}

			});
		}
	</script>
</body>

</html>
