<!DOCTYPE html>
<html lang="en">

<head>

	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
	<meta name="description" content="A collaborative programming text editor">
	<meta name="author" content="Techedit">

	<title>Techedit</title>


	<!-- Favicons -->

	<link rel="apple-touch-icon-precomposed" sizes="57x57" href="/favicon/apple-touch-icon-57x57.png" />
	<link rel="apple-touch-icon-precomposed" sizes="114x114" href="/favicon/apple-touch-icon-114x114.png" />
	<link rel="apple-touch-icon-precomposed" sizes="72x72" href="/favicon/apple-touch-icon-72x72.png" />
	<link rel="apple-touch-icon-precomposed" sizes="144x144" href="/favicon/apple-touch-icon-144x144.png" />
	<link rel="apple-touch-icon-precomposed" sizes="60x60" href="/favicon/apple-touch-icon-60x60.png" />
	<link rel="apple-touch-icon-precomposed" sizes="120x120" href="/favicon/apple-touch-icon-120x120.png" />
	<link rel="apple-touch-icon-precomposed" sizes="76x76" href="/favicon/apple-touch-icon-76x76.png" />
	<link rel="apple-touch-icon-precomposed" sizes="152x152" href="/favicon/apple-touch-icon-152x152.png" />
	<link rel="icon" type="image/png" href="/favicon/favicon-196x196.png" sizes="196x196" />
	<link rel="icon" type="image/png" href="/favicon/favicon-96x96.png" sizes="96x96" />
	<link rel="icon" type="image/png" href="/favicon/favicon-32x32.png" sizes="32x32" />
	<link rel="icon" type="image/png" href="/favicon/favicon-16x16.png" sizes="16x16" />
	<link rel="icon" type="image/png" href="/favicon/favicon-128.png" sizes="128x128" />
	<meta name="application-name" content="&nbsp;" />
	<meta name="msapplication-TileColor" content="#FFFFFF" />
	<meta name="msapplication-TileImage" content="/favicon/mstile-144x144.png" />
	<meta name="msapplication-square70x70logo" content="/favicon/mstile-70x70.png" />
	<meta name="msapplication-square150x150logo" content="/favicon/mstile-150x150.png" />
	<meta name="msapplication-wide310x150logo" content="/favicon/mstile-310x150.png" />
	<meta name="msapplication-square310x310logo" content="/favicon/mstile-310x310.png" />

	<!-- End Favicons -->

	<!-- Bootstrap core CSS -->
	<link href="/css/bootstrap.min.css" rel="stylesheet">

	<!-- Font Awesome Icons TODO: subset useed fonts to increase load time -->
	<script src="/font-awesome/js/fa-brands.min.js"></script>
	<script src="/font-awesome/js/fa-regular.min.js"></script>
	<script src="/font-awesome/js/fa-solid.min.js"></script>
	<script src="/font-awesome/js/fontawesome.min.js"></script>
	<!-- ACE -->
	<script src="/ace/ace.js" type="text/javascript" charset="utf-8"></script>

	<!-- Firebase and Firepad -->
	<script src="https://www.gstatic.com/firebasejs/4.8.1/firebase.js"></script>
	<script src="/js/firepad.min.js"></script>
	<link href="/css/firepad.min.css" rel="stylesheet">

	<!-- Custom styles -->
	<style>
		body {
			padding-top: 54px;
			min-height: 90%;
		}

		@media (min-width: 992px) {
			body {
				padding-top: 56px;
			}
		}

		.hidden {
			display: none;
		}

		.invisible {
			visibility: hidden;
		}

		/* Block Level */

		#block-code,
		#block-404 {
			margin-top: 20px;
			height: 600px;
		}

		/* Card */

		#file-wrapper,
		#chat-wrapper {
			margin-top: 20px;
			height: 560px;
			height:80%;
		}

		/* Editor */

		.firepad {
			/* Width of bootstrap card + padding + border */
			margin-top: 49px;
			margin-bottom: 51px;
			/* file-wrapper height - margin top - margin bottom*/
			height: 460px;
			
		}
		
		
		.firepad,
		#editor {

			position: absolute;
			top: 0;
			bottom: 0;
			right: 0;
			left: 0;
		}

		.powered-by-firepad {
			display: none;
		}

		/* Misc. Features*/

		#footer-cog,
		#footer-lang,
		#footer-pos {
			color: #717171;
		}

		#footer-cog:hover,
		#footer-lang:hover {
			color: #808080;
		}



		/* Aesthetics */

		#latest-msg-box {
			width: 100%;
			position: sticky;
			top: 10px;
		}

		#file-title {
			overflow-x: auto;
			white-space: nowrap;
		}

		#chat-msg-box {
			resize: none;
		}

		#options-sidebar {
			position: sticky;
			top: 50px;
			top: 8em;

		}

		#chat-messages {
			overflow-y: auto;

			overflow-wrap: normal;

		}


		.shadow {
			-moz-box-shadow: 0 0 3px #ccc;
			-webkit-box-shadow: 0 0 3px #ccc;
			box-shadow: 0 0 3px #ccc;
		}

		#name-enter,
		#msg-send {
			margin-top: 20px;
		}

		#options-nav {
			position: sticky;
		}

		.message>p {
			margin-top: 10px;
			overflow-x: visible;
			word-wrap: break-word;
		}

		.message {
			margin-top: 30px;
		}

		/* loader */

		.spinner {
			margin: 100px auto 0;
			width: 70px;
			text-align: center;
		}

		.spinner>div {
			width: 18px;
			height: 18px;
			background-color: #333;

			border-radius: 100%;
			display: inline-block;
			-webkit-animation: sk-bouncedelay 1.4s infinite ease-in-out both;
			animation: sk-bouncedelay 1.4s infinite ease-in-out both;
		}

		.spinner .bounce1 {
			-webkit-animation-delay: -0.32s;
			animation-delay: -0.32s;
		}

		.spinner .bounce2 {
			-webkit-animation-delay: -0.16s;
			animation-delay: -0.16s;
		}

		@-webkit-keyframes sk-bouncedelay {
			0%,
			80%,
			100% {
				-webkit-transform: scale(0)
			}
			40% {
				-webkit-transform: scale(1.0)
			}
		}

		@keyframes sk-bouncedelay {
			0%,
			80%,
			100% {
				-webkit-transform: scale(0);
				transform: scale(0);
			}
			40% {
				-webkit-transform: scale(1.0);
				transform: scale(1.0);
			}
		}
	</style>

</head>

<body>

	<!-- Navigation -->
	<nav class="navbar navbar-expand-lg navbar-dark bg-dark fixed-top">
		<div class="container">
			<a class="navbar-brand" href="/">Techedit</a>
			<button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarResponsive" aria-controls="navbarResponsive" aria-expanded="false" aria-label="Toggle navigation">
          <span class="navbar-toggler-icon"></span>
        </button>
			<div class="collapse navbar-collapse" id="navbarResponsive">
				<ul class="navbar-nav ml-auto">
					<li class="nav-item active">
						<a class="nav-link" href="/">Home
              </a>
					</li>
					<li class="nav-item">
						<a class="nav-link" href="#">About</a>
					</li>
					<li class="nav-item">
						<a class="nav-link" href="#">Services</a>
					</li>
					<li class="nav-item">
						<a class="nav-link" href="#">Contact</a>
					</li>
				</ul>
			</div>
		</div>
	</nav>
	<div class="container" id="block-load">
		<div class="row">
			<div class="col-lg-12 text-center">
				<div class="spinner" id="load-spinner">
					<div class="bounce1"></div>
					<div class="bounce2"></div>
					<div class="bounce3"></div>
				</div>
			</div>
		</div>
	</div>
	<!-- 404 Block -->
	<div class="container hidden" id="block-404">
		<div class="row">
			<div class="col-lg-12 text-center">
				<h1 class="mt-5">404 Error</h1>
				<p class="lead text-muted"><i>File Not Found</i></p>
				<hr>
				<p>There is no page at the current URL. It may have been renamed, moved, or deleted. If you typed a URL by hand, you may wish to double check your spelling.</p>
			</div>
		</div>
	</div>

	<!-- Code Block -->
	<!-- TODO: add hidden when done testing. -->
	<div class="container hidden" id="block-code">
		<div class="row">
			<div class="col-lg-8">

				<div class="card text-center" id="file-wrapper">
					<div class="card-header text-left" id="file-title">
						index.html
					</div>
					<div class="card-body" id="file-body">
						<div id="editor"></div>
					</div>
					<div class="card-footer text-muted text-right">
						<span id="footer-position">1:1</span>&nbsp;&nbsp;<span id="footer-lang">HTML</span>&nbsp;&nbsp;<a id="footer-cog" href="javascript:void(0)"><i class="fas fa-cog"></i></a>&nbsp;
					</div>
				</div>
			</div>
			<div class="col-lg-4">

				<div class="card" id="chat-wrapper">
					<div class="card-header text-left" id="chat-title">
						Chat
					</div>
					<div class="card-body" id="chat-messages">
						<div id="latest-msg-box" class="text-center">
							<a href="javascript:latestMsgHandler();" class="badge badge-primary shadow" id="latest-msg">Latest Message</a>
						</div>

						<p id="no-msg" class="text-muted">No Messages Yet. Be the first!</p>
						<div class="spinner" id="chat-spinner">
							<div class="bounce1"></div>
							<div class="bounce2"></div>
							<div class="bounce3"></div>
						</div>
					</div>
					<div class="card-footer text-muted text-right hidden " id="footer-send">
						<label for="name">Name:</label>
						<input class="form-control" placeholder="Message..." id="name">

						<button class="btn btn-primary btn-block" id="name-enter">Send</button>
					</div>
					<div class="card-footer text-muted text-right" id="footer-name">
						<textarea class="form-control" placeholder="Message..." id="chat-msg-box"></textarea>

						<button class="btn btn-primary btn-block" id="msg-send">Send</button>
					</div>
				</div>
			</div>
		</div>
	</div>
	<div class="modal fade in" tabindex="-1" role="dialog" id="options">
		<div class="modal-dialog modal-lg" role="document">
			<div class="modal-content">
				<div class="modal-header">
					<h5 class="modal-title">Options</h5>
					<button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
				</div>
				<div class="modal-body">
					<div class="container-fluid">

						<div class="row">
							<div class="col-md-3 ml-auto">

								<div id="options-nav" class="list-group">
									<a class="list-group-item list-group-item-action" href="#options-nav-item-1">Item 1</a>
									<a class="list-group-item list-group-item-action" href="#options-nav-item-2">Item 2</a>
									<a class="list-group-item list-group-item-action" href="#options-nav-item-3">Item 3</a>
									<a class="list-group-item list-group-item-action" href="#options-nav-item-4">Item 4</a>
								</div>
							</div>
							<div class="col-md-9 ml-auto">
								<h2 id="options-nav-item-1">Item 1</h2>
								Ex consequat commodo adipisicing exercitation aute excepteur occaecat ullamco duis aliqua id magna ullamco eu. Do aute ipsum ipsum ullamco cillum consectetur ut et aute consectetur labore. Fugiat laborum incididunt tempor eu consequat enim dolore proident.
								Qui laborum do non excepteur nulla magna eiusmod consectetur in. Aliqua et aliqua officia quis et incididunt voluptate non anim reprehenderit adipisicing dolore ut consequat deserunt mollit dolore. Aliquip nulla enim veniam non fugiat id cupidatat
								nulla elit cupidatat commodo velit ut eiusmod cupidatat elit dolore.


								<h2 id="options-nav-item-2">Item 2</h2>
								Ex consequat commodo adipisicing exercitation aute excepteur occaecat ullamco duis aliqua id magna ullamco eu. Do aute ipsum ipsum ullamco cillum consectetur ut et aute consectetur labore. Fugiat laborum incididunt tempor eu consequat enim dolore proident.
								Qui laborum do non excepteur nulla magna eiusmod consectetur in. Aliqua et aliqua officia quis et incididunt voluptate non anim reprehenderit adipisicing dolore ut consequat deserunt mollit dolore. Aliquip nulla enim veniam non fugiat id cupidatat
								nulla elit cupidatat commodo velit ut eiusmod cupidatat elit dolore.


								<h2 id="options-nav-item-3">Item 3</h2>Ex consequat commodo adipisicing exercitation aute excepteur occaecat ullamco duis aliqua id magna ullamco eu. Do aute ipsum ipsum ullamco cillum consectetur ut et aute consectetur labore. Fugiat laborum incididunt tempor eu consequat
								enim dolore proident. Qui laborum do non excepteur nulla magna eiusmod consectetur in. Aliqua et aliqua officia quis et incididunt voluptate non anim reprehenderit adipisicing dolore ut consequat deserunt mollit dolore. Aliquip nulla enim veniam
								non fugiat id cupidatat nulla elit cupidatat commodo velit ut eiusmod cupidatat elit dolore.


								<h2 id="options-nav-item-4">Item 4</h2>
								Ex consequat commodo adipisicing exercitation aute excepteur occaecat ullamco duis aliqua id magna ullamco eu. Do aute ipsum ipsum ullamco cillum consectetur ut et aute consectetur labore. Fugiat laborum incididunt tempor eu consequat enim dolore proident.
								Qui laborum do non excepteur nulla magna eiusmod consectetur in. Aliqua et aliqua officia quis et incididunt voluptate non anim reprehenderit adipisicing dolore ut consequat deserunt mollit dolore. Aliquip nulla enim veniam non fugiat id cupidatat
								nulla elit cupidatat commodo velit ut eiusmod cupidatat elit dolore.


							</div>

						</div>
					</div>
					<div class="modal-footer">
						<button type="button" class="btn btn-primary">Save changes</button>
						<button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
					</div>
				</div>
			</div>
		</div>
	</div>




	<!-- Bootstrap core JavaScript -->
	<script src="/js/jquery.min.js"></script>
	<script src="/js/bootstrap.bundle.min.js"></script>
	<script src="/js/showdown.min.js"></script>
	<script>
		/* global firebase ace Firepad navigator $*/

		//some utility function
		String.prototype.replaceAll = function(search, replacement) {
			var target = this;
			return target.replace(new RegExp(search, "g"), replacement);
		};

		function insertAtCaret(areaId, text) {
			var txtarea = document.getElementById(areaId);
			if (!txtarea) { return; }

			var scrollPos = txtarea.scrollTop;
			var strPos = 0;
			var br = ((txtarea.selectionStart || txtarea.selectionStart == "0") ?
				"ff" : (document.selection ? "ie" : false));
			if (br == "ie") {
				txtarea.focus();
				var range = document.selection.createRange();
				range.moveStart("character", -txtarea.value.length);
				strPos = range.text.length;
			}
			else if (br == "ff") {
				strPos = txtarea.selectionStart;
			}

			var front = (txtarea.value).substring(0, strPos);
			var back = (txtarea.value).substring(strPos, txtarea.value.length);
			txtarea.value = front + text + back;
			strPos = strPos + text.length;
			if (br == "ie") {
				txtarea.focus();
				var ieRange = document.selection.createRange();
				ieRange.moveStart("character", -txtarea.value.length);
				ieRange.moveStart("character", strPos);
				ieRange.moveEnd("character", 0);
				ieRange.select();
			}
			else if (br == "ff") {
				txtarea.selectionStart = strPos;
				txtarea.selectionEnd = strPos;
				txtarea.focus();
			}

			txtarea.scrollTop = scrollPos;
		}



		//initalize firebase
		var config = {
			apiKey: "AIzaSyBQ2E4ISQoIcRsDxfPxzDjbJwmD-r98JYw",
			authDomain: "techedit-63e7f.firebaseapp.com",
			databaseURL: "https://techedit-63e7f.firebaseio.com",
			projectId: "techedit-63e7f",
			storageBucket: "techedit-63e7f.appspot.com",
			messagingSenderId: "609280907475"
		};
		firebase.initializeApp(config);

		//key of latest message
		//var lastMsg;
		//var newMessages;
		// Get Firebase Database reference.
		var ref = firebase.database().ref("/f/test/");
		var chatRef = firebase.database().ref("/f/test/chat/");

		//Set up ace
		var editor = ace.edit("editor");
		editor.setTheme("ace/theme/xcode");
		editor.getSession().setMode("ace/mode/html");
		editor.setShowPrintMargin(false);
		editor.getSession().setUseWorker(false);

		// Create Firepad.
		var firepad = Firepad.fromACE(ref, editor);


		//initate the position tracker
		editor.getSession().selection.on("changeCursor", function(e) {
			var pos = editor.getCursorPosition();
			//console.log(pos);
			$("#footer-position").html((pos.row + 1) + ":" + (pos.column + 1));
		});

		//show the settings modal when the user clicks on the cog icon
		$("#footer-cog").click(function() {
			$("#options").modal("show");
		});

		//show the editor only when firepad and ace are ready
		firepad.on("ready", function() {
			$("#chat-messages").scrollTop($("#chat-messages")[0].scrollHeight);

			$("#block-load").addClass("hidden");
			$("#block-code").removeClass("hidden");
		});


		//use the child added event on the last 50(for initalization), 
		//so the first 50 messages are loaded, and then all new messages are loaded.
		var numLoaded = 0;
		var numToLoad = 50;
		chatRef.orderByKey().limitToLast(numToLoad).on("child_added", function(data) {
			if (numLoaded < numToLoad) {
				console.log("Only " + (numLoaded + 1) + " loaded: Scrolled");
				//$("#chat-messages").on("scroll", chatScrollHandler);
				// "pause the scroll handler"
				$("#chat-messages").off("scroll");
				//scroll
				$("#chat-messages").stop().animate({
					scrollTop: $("#chat-messages")[0].scrollHeight
				}, 800);
				//"unpause" the scroll back to latest btn
				$("#chat-messages").on("scroll", chatScrollHandler);
				numLoaded++;
			}
			else if ($("#chat-messages")[0].scrollHeight - $("#chat-messages").scrollTop() == $("#chat-messages").innerHeight()) {
				//scroll to bottom
				console.log("At bottom: Scrolled");
				//$("#chat-messages").on("scroll", chatScrollHandler);
				// "pause the scroll handler"
				$("#chat-messages").off("scroll");
				//scrolls
				$("#chat-messages").stop().animate({
					scrollTop: $("#chat-messages")[0].scrollHeight
				}, 800);
				//"unpause" the scroll back to latest btn
				$("#chat-messages").on("scroll", chatScrollHandler);

			}
			else {
				console.log("Not At bottom: Did not scroll");
			}

			$("#chat-messages").append("<div class='message' id='msg_'" + data.key + "'data-key='" + data.key + "'>" + data.val() + "</div>");

			// as soon as a message is loaded, we remove the no messages text.
			if (!$("#no-msg").hasClass("hidden")) {
				$("#no-msg").addClass("hidden");
			}



		});
		//Initalize ShowDown, a markdown parser for the chat.
		var converter = new showdown.Converter({
			simplifiedAutoLink: true,
			excludeTrailingPunctuationFromURLs: true,
			openLinksInNewWindow: true,
			underline: true

		});

		//when enter is presed, simulate a send button click.
		$("#chat-msg-box").keydown(function(e) {
			var keyCode;
			if (e.keyCode == 13) {
				e.preventDefault();
			}
			if (window.event) {
				keyCode = window.event.keyCode;
			}
			else {
				keyCode = e.keyCode || e.which;
			}

			if ((!e.shiftKey && (keyCode == 13))) {
				//Send the message if only the enter key is pressed
				$("#msg-send").click();

			}
			else if ((e.shiftKey && (keyCode == 13)) || (keyCode == 10)) {
				//If they type shift+enter, we insert a new line.
				insertAtCaret("chat-msg-box", "\n");

			}
			else if (e.keyCode == 83 && (navigator.platform.match("Mac") ? e.metaKey : e.ctrlKey)) {
				e.preventDefault();

			}

			//return false;
		});
		//send a message.
		$("#msg-send").click(function() {
			//send the message to firebase.
			chatRef.push(converter.makeHtml($("#chat-msg-box").val().replaceAll("<", "&lt;").replaceAll(">", "&gt;")));
			//clear the textarea and restore focus.
			$("#chat-msg-box").val("");
			$("#chat-msg-box").focus();

		});

		//if the user is already scrolled to the bottom of the message div, we autoscroll on new messages.
		//$("#chat-messages").scrollTop($("#chat-messages").prop("scrollHeight"));
		$("#chat-messages").on("scroll", chatScrollHandler);

		function chatScrollHandler() {
			if ($(this).scrollTop() + $(this).innerHeight() >= $(this)[0].scrollHeight) {
				//scrolled to bottom
				$("#latest-msg").addClass("hidden");
			}
			else {
				$("#latest-msg").removeClass("hidden");
			}
		}
		/*$("#latest-msg, #latest-msg-box").click(latestMsgHandler);*/
		function latestMsgHandler() {
			$("#chat-messages").stop().animate({
				scrollTop: $("#chat-messages")[0].scrollHeight
			}, 800);
		}
	</script>


</body>

</html>
